<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœ¯æœºå™¨äººæç¤ºè¯ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-active {
            background: rgba(102, 126, 234, 0.2);
            border-bottom: 2px solid #667eea;
        }
        
        /* ä¼˜åŒ–ä¸‹æ‹‰èœå•æ˜¾ç¤º */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23ffffff' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
        }
        
        select option {
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
        }
        
        select optgroup {
            background-color: #374151;
            color: #9ca3af;
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        select optgroup option {
            background-color: #1f2937;
            color: white;
            padding-left: 20px;
        }
        
        /* APIçŠ¶æ€æ ·å¼ */
        .api-status-success {
            background-color: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }
        
        .api-status-error {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .api-status-testing {
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">AIæç¤ºè¯ç”Ÿæˆå™¨</h1>
            <p class="text-white/80">æ™ºèƒ½ç”Ÿæˆé«˜è´¨é‡çš„AIæç¤ºè¯ï¼Œæ”¯æŒä¸»é¢˜ç”Ÿæˆå’Œå›¾ç‰‡åæ¨</p>
            
            <!-- æ”¯æŒçš„æ¨¡å‹æç¤º -->
            <div class="mt-4 text-sm text-white/60">
                <p>ğŸš€ æ”¯æŒå¤šç§ä¸»æµAIæ¨¡å‹ï¼šOpenAI GPT-4 â€¢ Google Gemini 2.5 Flash â€¢ DeepSeek â€¢ Claude â€¢ é€šä¹‰åƒé—® â€¢ æ–‡å¿ƒä¸€è¨€ â€¢ ChatGLM â€¢ Kimi</p>
                <p class="mt-1">âœ¨ æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹ï¼šéšæ—¶æ·»åŠ æœ€æ–°å‘å¸ƒçš„AIæ¨¡å‹</p>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
                <div class="lg:col-span-1">
                    <div class="glass rounded-lg p-6 text-white">
                        <h2 class="text-xl font-semibold mb-4">
                            <i class="fas fa-cog mr-2"></i>APIé…ç½®
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">APIç±»å‹</label>
                                <select id="apiType" onchange="updateApiDefaults()" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="anthropic">Anthropic Claude</option>
                                    <option value="qwen">é˜¿é‡Œé€šä¹‰åƒé—®</option>
                                    <option value="baidu">ç™¾åº¦æ–‡å¿ƒä¸€è¨€</option>
                                    <option value="zhipu">æ™ºè°±ChatGLM</option>
                                    <option value="moonshot">æœˆä¹‹æš—é¢Kimi</option>
                                    <option value="custom">è‡ªå®šä¹‰OpenAIæ ¼å¼</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">APIåœ°å€</label>
                                <input type="text" id="apiUrl" placeholder="APIåœ°å€å°†è‡ªåŠ¨å¡«å……" 
                                       class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white placeholder-white/50">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">API Key</label>
                                <div class="relative">
                                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„API Key" 
                                           class="w-full px-3 py-2 pr-10 bg-white/10 border border-white/20 rounded text-white placeholder-white/50">
                                    <button type="button" onclick="toggleApiKeyVisibility()" 
                                            class="absolute right-2 top-2 text-white/60 hover:text-white">
                                        <i id="apiKeyToggleIcon" class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">æ¨¡å‹</label>
                                <select id="model" onchange="toggleCustomModel()" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white">
                                    <option value="gpt-4">gpt-4</option>
                                </select>
                                
                                <!-- è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡† -->
                                <div id="customModelDiv" class="hidden mt-2">
                                    <input type="text" id="customModel" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°" 
                                           class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white placeholder-white/50">
                                    <p class="text-xs text-white/60 mt-1">ä¾‹å¦‚ï¼šgpt-4-1106-preview, gemini-2.5-flash ç­‰</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition">
                                    <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
                                </button>
                                <button onclick="testAPIConnection()" id="testApiBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition">
                                    <i class="fas fa-plug mr-2"></i>æµ‹è¯•è¿æ¥
                                </button>
                            </div>
                            
                            <!-- APIè¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                            <div id="apiStatus" class="hidden p-3 rounded-lg text-sm">
                                <div id="apiStatusContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="glass rounded-lg p-6 text-white mt-6">
                        <h2 class="text-xl font-semibold mb-4">
                            <i class="fas fa-history mr-2"></i>å†å²è®°å½•
                        </h2>
                        <div id="historyList" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <button onclick="clearHistory()" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition text-sm">
                            æ¸…ç©ºå†å²
                        </button>
                    </div>
                </div>

                <!-- å³ä¾§ä¸»è¦åŠŸèƒ½åŒº -->
                <div class="lg:col-span-2">
                    <div class="glass rounded-lg p-6 text-white">
                        <!-- é€‰é¡¹å¡ -->
                        <div class="flex mb-6 border-b border-white/20">
                            <button id="textTab" onclick="switchTab('text')" class="px-4 py-2 tab-active">
                                <i class="fas fa-keyboard mr-2"></i>ä¸»é¢˜ç”Ÿæˆ
                            </button>
                            <button id="imageTab" onclick="switchTab('image')" class="px-4 py-2">
                                <i class="fas fa-image mr-2"></i>å›¾ç‰‡åæ¨
                            </button>
                        </div>

                        <!-- ä¸»é¢˜ç”Ÿæˆé¢æ¿ -->
                        <div id="textPanel">
                            <h3 class="text-lg font-semibold mb-4">è¾“å…¥ä¸»é¢˜ç”Ÿæˆæç¤ºè¯</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">ä¸»é¢˜æè¿°</label>
                                    <textarea id="topicInput" rows="3" placeholder="ä¾‹å¦‚ï¼šè®¾è®¡ä¸€ä¸ªç°ä»£ç®€çº¦é£æ ¼çš„ç½‘ç«™é¦–é¡µ" 
                                             class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white placeholder-white/50"></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">åº”ç”¨ç±»å‹</label>
                                        <select id="appType" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white">
                                            <option value="">è¯·é€‰æ‹©</option>
                                            <optgroup label="åŒ»ç–—ä¸“ä¸š">
                                                <option value="ç¥ç»å¤–ç§‘æ‰‹æœ¯è§„åˆ’">ç¥ç»å¤–ç§‘æ‰‹æœ¯è§„åˆ’</option>
                                                <option value="æ‰‹æœ¯å¯¼èˆªç³»ç»Ÿ">æ‰‹æœ¯å¯¼èˆªç³»ç»Ÿ</option>
                                                <option value="æ‰‹æœ¯æœºå™¨äººæ“ä½œ">æ‰‹æœ¯æœºå™¨äººæ“ä½œ</option>
                                                <option value="åŒ»å­¦å½±åƒåˆ†æ">åŒ»å­¦å½±åƒåˆ†æ</option>
                                                <option value="æ‰‹æœ¯å™¨æ¢°è®¾è®¡">æ‰‹æœ¯å™¨æ¢°è®¾è®¡</option>
                                                <option value="åŒ»ç–—è®¾å¤‡äº§å“æ–‡æ¡£">åŒ»ç–—è®¾å¤‡äº§å“æ–‡æ¡£</option>
                                                <option value="ä¸´åºŠå†³ç­–æ”¯æŒ">ä¸´åºŠå†³ç­–æ”¯æŒ</option>
                                                <option value="æ‰‹æœ¯åŸ¹è®­æ¨¡æ‹Ÿ">æ‰‹æœ¯åŸ¹è®­æ¨¡æ‹Ÿ</option>
                                                <option value="åŒ»ç–—æ•°æ®åˆ†æ">åŒ»ç–—æ•°æ®åˆ†æ</option>
                                                <option value="ç›‘ç®¡æ–‡ä»¶æ’°å†™">ç›‘ç®¡æ–‡ä»¶æ’°å†™</option>
                                            </optgroup>
                                            <optgroup label="é€šç”¨åº”ç”¨">
                                                <option value="å›¾ç‰‡ç”Ÿæˆ">å›¾ç‰‡ç”Ÿæˆ</option>
                                                <option value="æ–‡æ¡ˆå†™ä½œ">æ–‡æ¡ˆå†™ä½œ</option>
                                                <option value="ä»£ç å¼€å‘">ä»£ç å¼€å‘</option>
                                                <option value="æ•°æ®åˆ†æ">æ•°æ®åˆ†æ</option>
                                                <option value="åˆ›æ„è®¾è®¡">åˆ›æ„è®¾è®¡</option>
                                                <option value="äº§å“éœ€æ±‚æ–‡æ¡£">äº§å“éœ€æ±‚æ–‡æ¡£</option>
                                                <option value="æŠ€æœ¯æ–‡æ¡£">æŠ€æœ¯æ–‡æ¡£</option>
                                                <option value="ç”¨æˆ·ç ”ç©¶">ç”¨æˆ·ç ”ç©¶</option>
                                                <option value="å…¶ä»–">å…¶ä»–</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">è¯¦ç»†ç¨‹åº¦</label>
                                        <select id="detailLevel" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white">
                                            <option value="ç®€æ´">ç®€æ´</option>
                                            <option value="è¯¦ç»†">è¯¦ç»†</option>
                                            <option value="éå¸¸è¯¦ç»†">éå¸¸è¯¦ç»†</option>
                                        </select>
                                    </div>
                                </div>

                                <button onclick="generateFromText()" id="generateTextBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded transition">
                                    <i class="fas fa-magic mr-2"></i>ç”Ÿæˆæç¤ºè¯
                                </button>
                            </div>
                        </div>

                        <!-- å›¾ç‰‡åæ¨é¢æ¿ -->
                        <div id="imagePanel" class="hidden">
                            <h3 class="text-lg font-semibold mb-4">ä¸Šä¼ å›¾ç‰‡åæ¨æç¤ºè¯</h3>
                            <div class="space-y-4">
                                <div class="border-2 border-dashed border-white/30 rounded-lg p-8 text-center">
                                    <div id="uploadArea" onclick="document.getElementById('imageUpload').click()" class="cursor-pointer">
                                        <i class="fas fa-cloud-upload-alt text-4xl mb-2"></i>
                                        <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                                        <p class="text-sm text-white/70 mt-2">æ”¯æŒ JPG, PNG, GIF æ ¼å¼</p>
                                    </div>
                                    <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                                    <div id="imagePreview" class="hidden mt-4">
                                        <img id="previewImg" class="max-w-full max-h-48 mx-auto rounded">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">åˆ†æé‡ç‚¹</label>
                                    <select id="analysisType" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white">
                                        <optgroup label="åŒ»ç–—ä¸“ä¸š">
                                            <option value="åŒ»å­¦å½±åƒåˆ†æ">åŒ»å­¦å½±åƒåˆ†æ</option>
                                            <option value="æ‰‹æœ¯åœºæ™¯åˆ†æ">æ‰‹æœ¯åœºæ™¯åˆ†æ</option>
                                            <option value="åŒ»ç–—è®¾å¤‡è¯†åˆ«">åŒ»ç–—è®¾å¤‡è¯†åˆ«</option>
                                            <option value="è§£å‰–ç»“æ„åˆ†æ">è§£å‰–ç»“æ„åˆ†æ</option>
                                            <option value="ä¸´åºŠç¯å¢ƒåˆ†æ">ä¸´åºŠç¯å¢ƒåˆ†æ</option>
                                        </optgroup>
                                        <optgroup label="é€šç”¨åˆ†æ">
                                            <option value="å…¨é¢åˆ†æ">å…¨é¢åˆ†æ</option>
                                            <option value="é£æ ¼åˆ†æ">é£æ ¼åˆ†æ</option>
                                            <option value="æ„å›¾åˆ†æ">æ„å›¾åˆ†æ</option>
                                            <option value="è‰²å½©åˆ†æ">è‰²å½©åˆ†æ</option>
                                            <option value="å†…å®¹åˆ†æ">å†…å®¹åˆ†æ</option>
                                            <option value="æŠ€æœ¯å‚æ•°åˆ†æ">æŠ€æœ¯å‚æ•°åˆ†æ</option>
                                        </optgroup>
                                    </select>
                                </div>

                                <button onclick="generateFromImage()" id="generateImageBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded transition">
                                    <i class="fas fa-search mr-2"></i>åˆ†æå›¾ç‰‡ç”Ÿæˆæç¤ºè¯
                                </button>
                            </div>
                        </div>

                        <!-- ç»“æœæ˜¾ç¤ºåŒº -->
                        <div id="resultArea" class="mt-8 hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">ç”Ÿæˆç»“æœ</h3>
                                <button onclick="clearResult()" class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition">
                                    <i class="fas fa-trash mr-1"></i>æ¸…é™¤
                                </button>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-white/70">ç”Ÿæˆçš„æç¤ºè¯</span>
                                    <button onclick="copyResult()" class="text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded">
                                        <i class="fas fa-copy mr-1"></i>å¤åˆ¶
                                    </button>
                                </div>
                                <div id="resultText" class="bg-black/20 rounded p-3 min-h-24 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let config = {
            apiType: 'openai',
            apiUrl: 'https://api.openai.com/v1',
            apiKey: '',
            model: 'gpt-4'
        };
        let currentImage = null;

        // APIé¢„è®¾é…ç½®
        const apiConfigs = {
            openai: {
                url: 'https://api.openai.com/v1',
                models: [
                    'gpt-4',
                    'gpt-4-turbo',
                    'gpt-4o',
                    'gpt-4o-mini',
                    'gpt-3.5-turbo',
                    'gpt-3.5-turbo-16k',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            gemini: {
                url: 'https://generativelanguage.googleapis.com/v1beta',
                models: [
                    'gemini-2.5-flash',
                    'gemini-2.0-flash-exp',
                    'gemini-1.5-pro',
                    'gemini-1.5-flash',
                    'gemini-pro',
                    'gemini-pro-vision',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            deepseek: {
                url: 'https://api.deepseek.com/v1',
                models: [
                    'deepseek-chat',
                    'deepseek-coder',
                    'deepseek-reasoner',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            anthropic: {
                url: 'https://api.anthropic.com/v1',
                models: [
                    'claude-3-5-sonnet-20241022',
                    'claude-3-5-haiku-20241022',
                    'claude-3-opus-20240229',
                    'claude-3-sonnet-20240229',
                    'claude-3-haiku-20240307',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            qwen: {
                url: 'https://dashscope.aliyuncs.com/api/v1',
                models: [
                    'qwen-turbo',
                    'qwen-plus',
                    'qwen-max',
                    'qwen-max-longcontext',
                    'qwen-vl-plus',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            baidu: {
                url: 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1',
                models: [
                    'ernie-4.0-8k',
                    'ernie-3.5-8k',
                    'ernie-3.5-4k',
                    'ernie-speed-8k',
                    'ernie-lite-8k',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            zhipu: {
                url: 'https://open.bigmodel.cn/api/paas/v4',
                models: [
                    'glm-4-plus',
                    'glm-4-0520',
                    'glm-4',
                    'glm-4v',
                    'glm-3-turbo',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            moonshot: {
                url: 'https://api.moonshot.cn/v1',
                models: [
                    'moonshot-v1-8k',
                    'moonshot-v1-32k',
                    'moonshot-v1-128k',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            },
            custom: {
                url: '',
                models: [
                    'gpt-4',
                    'gpt-3.5-turbo',
                    'è‡ªå®šä¹‰æ¨¡å‹'
                ]
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†
        function toggleCustomModel() {
            const modelSelect = document.getElementById('model');
            const customModelDiv = document.getElementById('customModelDiv');
            
            if (modelSelect.value === 'è‡ªå®šä¹‰æ¨¡å‹') {
                customModelDiv.classList.remove('hidden');
            } else {
                customModelDiv.classList.add('hidden');
            }
        }

        // è·å–å®é™…ä½¿ç”¨çš„æ¨¡å‹åç§°
        function getActualModel() {
            const modelSelect = document.getElementById('model');
            if (modelSelect.value === 'è‡ªå®šä¹‰æ¨¡å‹') {
                const customModel = document.getElementById('customModel').value.trim();
                return customModel || modelSelect.value;
            }
            return modelSelect.value;
        }

        // æ¸…é™¤ç”Ÿæˆç»“æœ
        function clearResult() {
            const resultArea = document.getElementById('resultArea');
            const resultText = document.getElementById('resultText');
            
            resultText.textContent = '';
            resultArea.classList.add('hidden');
        }

        // åˆ‡æ¢API Keyå¯è§æ€§
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.getElementById('apiKeyToggleIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            const btn = document.getElementById('testApiBtn');
            const statusDiv = document.getElementById('apiStatus');
            const statusContent = document.getElementById('apiStatusContent');
            
            // å…ˆæ›´æ–°é…ç½®åˆ°å†…å­˜
            config.apiType = document.getElementById('apiType').value;
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.model = getActualModel(); // ä½¿ç”¨å®é™…æ¨¡å‹åç§°
            
            // æ£€æŸ¥é…ç½®
            if (!config.apiKey.trim()) {
                showAPIStatus('error', 'âŒ è¯·å…ˆè¾“å…¥API Key');
                return;
            }
            
            if (!config.apiUrl.trim()) {
                showAPIStatus('error', 'âŒ è¯·å…ˆè¾“å…¥APIåœ°å€');
                return;
            }
            
            if (!config.model.trim()) {
                showAPIStatus('error', 'âŒ è¯·å…ˆé€‰æ‹©æ¨¡å‹æˆ–è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°');
                return;
            }
            
            // æ£€æŸ¥è‡ªå®šä¹‰æ¨¡å‹æ˜¯å¦ä¸ºç©º
            const modelSelect = document.getElementById('model');
            if (modelSelect.value === 'è‡ªå®šä¹‰æ¨¡å‹') {
                const customModel = document.getElementById('customModel').value.trim();
                if (!customModel) {
                    showAPIStatus('error', 'âŒ è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°');
                    return;
                }
            }
            
            // å¼€å§‹æµ‹è¯•
            btn.innerHTML = '<div class="loading inline-block mr-2"></div>æµ‹è¯•ä¸­...';
            btn.disabled = true;
            showAPIStatus('testing', 'ğŸ”„ æ­£åœ¨æµ‹è¯•APIè¿æ¥...');
            
            try {
                // æ ¹æ®APIç±»å‹å‘é€ä¸åŒçš„æµ‹è¯•è¯·æ±‚
                let testPrompt;
                if (config.apiType === 'gemini') {
                    testPrompt = "è¯·ç®€å•å›å¤'è¿æ¥æˆåŠŸ'";
                } else {
                    testPrompt = "Hello, please respond with 'API connection successful'.";
                }
                
                const startTime = Date.now();
                const result = await callAPI(testPrompt);
                const responseTime = Date.now() - startTime;
                
                // éªŒè¯å“åº”æ˜¯å¦æœ‰æ•ˆ
                if (!result || result.trim().length === 0) {
                    throw new Error('APIè¿”å›ç©ºå“åº”');
                }
                
                const responsePreview = result.length > 50 ? result.substring(0, 50) + '...' : result;
                
                showAPIStatus('success', `âœ… APIè¿æ¥æˆåŠŸï¼<br>
                    ğŸ“Š å“åº”æ—¶é—´: ${responseTime}ms<br>
                    ğŸ¤– APIç±»å‹: ${config.apiType}<br>
                    ğŸ¯ æ¨¡å‹: ${config.model}<br>
                    ğŸ’¬ å“åº”é¢„è§ˆ: "${responsePreview}"`);
                
            } catch (error) {
                let errorMessage = error.message;
                
                // è§£æå¸¸è§é”™è¯¯ç±»å‹
                if (errorMessage.includes('401') || errorMessage.includes('invalid_api_key')) {
                    errorMessage = 'API Keyæ— æ•ˆæˆ–å·²è¿‡æœŸ';
                } else if (errorMessage.includes('403')) {
                    errorMessage = 'APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–ä½™é¢';
                } else if (errorMessage.includes('404')) {
                    errorMessage = 'APIåœ°å€é”™è¯¯æˆ–æ¨¡å‹ä¸å­˜åœ¨';
                } else if (errorMessage.includes('429')) {
                    errorMessage = 'APIè°ƒç”¨é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•';
                } else if (errorMessage.includes('500')) {
                    errorMessage = 'APIæœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                } else if (errorMessage.includes('Network Error') || errorMessage.includes('Failed to fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥APIåœ°å€';
                } else if (errorMessage.includes('CORS')) {
                    errorMessage = 'CORSè·¨åŸŸé”™è¯¯ï¼Œå¯èƒ½éœ€è¦ä»£ç†';
                }
                
                showAPIStatus('error', `âŒ APIè¿æ¥å¤±è´¥<br>
                    ğŸ”— APIç±»å‹: ${config.apiType}<br>
                    ğŸ¯ æ¨¡å‹: ${config.model}<br>
                    âš ï¸ é”™è¯¯: ${errorMessage}`);
                
            } finally {
                btn.innerHTML = '<i class="fas fa-plug mr-2"></i>æµ‹è¯•è¿æ¥';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºAPIçŠ¶æ€
        function showAPIStatus(type, message) {
            const statusDiv = document.getElementById('apiStatus');
            const statusContent = document.getElementById('apiStatusContent');
            
            statusDiv.className = `p-3 rounded-lg text-sm api-status-${type}`;
            statusContent.innerHTML = message;
            statusDiv.classList.remove('hidden');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (window.statusTimer) {
                clearTimeout(window.statusTimer);
            }
            
            // æˆåŠŸæ¶ˆæ¯5ç§’åè‡ªåŠ¨éšè—ï¼Œé”™è¯¯æ¶ˆæ¯æ‰‹åŠ¨ç‚¹å‡»éšè—
            if (type === 'success') {
                window.statusTimer = setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            } else if (type === 'error') {
                // ä¸ºé”™è¯¯æ¶ˆæ¯æ·»åŠ ç‚¹å‡»éšè—åŠŸèƒ½
                statusDiv.style.cursor = 'pointer';
                statusDiv.onclick = () => {
                    statusDiv.classList.add('hidden');
                    statusDiv.onclick = null;
                    statusDiv.style.cursor = 'default';
                };
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadHistory();
            updateApiDefaults(); // åˆå§‹åŒ–APIé»˜è®¤å€¼
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload({target: {files: files}});
                }
            });
        });

        // æ›´æ–°APIé»˜è®¤é…ç½®
        function updateApiDefaults() {
            const apiType = document.getElementById('apiType').value;
            const apiUrlInput = document.getElementById('apiUrl');
            const modelSelect = document.getElementById('model');
            const customModelDiv = document.getElementById('customModelDiv');
            
            const selectedConfig = apiConfigs[apiType];
            const currentUrl = apiUrlInput.value;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°APIåœ°å€
            const shouldUpdateUrl = !currentUrl || 
                Object.values(apiConfigs).some(config => config.url === currentUrl);
            
            // æ›´æ–°APIåœ°å€
            if (shouldUpdateUrl && selectedConfig.url) {
                apiUrlInput.value = selectedConfig.url;
            }
            
            // æ›´æ–°æ¨¡å‹é€‰é¡¹
            modelSelect.innerHTML = '';
            selectedConfig.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // è®¾ç½®é»˜è®¤æ¨¡å‹
            if (selectedConfig.models.length > 0) {
                modelSelect.value = selectedConfig.models[0];
            }
            
            // éšè—è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†
            if (customModelDiv) {
                customModelDiv.classList.add('hidden');
            }
            
            // éšè—ä¹‹å‰çš„çŠ¶æ€æ¶ˆæ¯
            const statusDiv = document.getElementById('apiStatus');
            if (statusDiv) {
                statusDiv.classList.add('hidden');
            }
            
            // æ›´æ–°å ä½ç¬¦æç¤º
            switch(apiType) {
                case 'gemini':
                    apiUrlInput.placeholder = 'Google Gemini APIåœ°å€';
                    break;
                case 'deepseek':
                    apiUrlInput.placeholder = 'DeepSeek APIåœ°å€';
                    break;
                case 'anthropic':
                    apiUrlInput.placeholder = 'Anthropic Claude APIåœ°å€';
                    break;
                case 'qwen':
                    apiUrlInput.placeholder = 'é˜¿é‡Œäº‘APIåœ°å€';
                    break;
                case 'baidu':
                    apiUrlInput.placeholder = 'ç™¾åº¦APIåœ°å€';
                    break;
                case 'zhipu':
                    apiUrlInput.placeholder = 'æ™ºè°±APIåœ°å€';
                    break;
                case 'moonshot':
                    apiUrlInput.placeholder = 'Moonshot APIåœ°å€';
                    break;
                case 'custom':
                    apiUrlInput.placeholder = 'è¯·è¾“å…¥è‡ªå®šä¹‰APIåœ°å€';
                    break;
                default:
                    apiUrlInput.placeholder = 'OpenAI APIåœ°å€';
            }
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tab) {
            document.getElementById('textTab').classList.remove('tab-active');
            document.getElementById('imageTab').classList.remove('tab-active');
            document.getElementById('textPanel').classList.add('hidden');
            document.getElementById('imagePanel').classList.add('hidden');
            
            if (tab === 'text') {
                document.getElementById('textTab').classList.add('tab-active');
                document.getElementById('textPanel').classList.remove('hidden');
            } else {
                document.getElementById('imageTab').classList.add('tab-active');
                document.getElementById('imagePanel').classList.remove('hidden');
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            config.apiType = document.getElementById('apiType').value;
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.model = getActualModel(); // ä½¿ç”¨å®é™…æ¨¡å‹åç§°
            config.selectedModel = document.getElementById('model').value; // ä¿å­˜é€‰æ‹©çš„é€‰é¡¹
            config.customModel = document.getElementById('customModel').value; // ä¿å­˜è‡ªå®šä¹‰æ¨¡å‹
            
            localStorage.setItem('promptGeneratorConfig', JSON.stringify(config));
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸçŠ¶æ€
            showAPIStatus('success', 'âœ… é…ç½®å·²ä¿å­˜ï¼');
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('promptGeneratorConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiType').value = config.apiType;
                document.getElementById('apiUrl').value = config.apiUrl;
                document.getElementById('apiKey').value = config.apiKey;
                
                // å…ˆæ›´æ–°APIé»˜è®¤å€¼ï¼Œå†è®¾ç½®æ¨¡å‹
                updateApiDefaults();
                
                // æ¢å¤æ¨¡å‹é€‰æ‹©
                if (config.selectedModel) {
                    document.getElementById('model').value = config.selectedModel;
                    if (config.selectedModel === 'è‡ªå®šä¹‰æ¨¡å‹' && config.customModel) {
                        document.getElementById('customModel').value = config.customModel;
                        toggleCustomModel();
                    }
                } else if (config.model) {
                    // å…¼å®¹æ—§ç‰ˆæœ¬é…ç½®
                    const modelSelect = document.getElementById('model');
                    const options = Array.from(modelSelect.options).map(opt => opt.value);
                    if (options.includes(config.model)) {
                        modelSelect.value = config.model;
                    } else {
                        // å¦‚æœä¿å­˜çš„æ¨¡å‹ä¸åœ¨é¢„è®¾åˆ—è¡¨ä¸­ï¼Œè®¾ä¸ºè‡ªå®šä¹‰æ¨¡å‹
                        modelSelect.value = 'è‡ªå®šä¹‰æ¨¡å‹';
                        document.getElementById('customModel').value = config.model;
                        toggleCustomModel();
                    }
                }
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    document.getElementById('previewImg').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // ä»ä¸»é¢˜ç”Ÿæˆæç¤ºè¯
        async function generateFromText() {
            const topic = document.getElementById('topicInput').value;
            const appType = document.getElementById('appType').value;
            const detailLevel = document.getElementById('detailLevel').value;
            
            if (!topic.trim()) {
                showAPIStatus('error', 'âŒ è¯·è¾“å…¥ä¸»é¢˜æè¿°');
                return;
            }
            
            // æ›´æ–°é…ç½®åˆ°å†…å­˜
            config.apiType = document.getElementById('apiType').value;
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.model = getActualModel();
            
            if (!config.apiKey) {
                showAPIStatus('error', 'âŒ è¯·å…ˆé…ç½®API Key');
                return;
            }

            const btn = document.getElementById('generateTextBtn');
            btn.innerHTML = '<div class="loading inline-block mr-2"></div>ç”Ÿæˆä¸­...';
            btn.disabled = true;

            try {
                // æ ¹æ®åº”ç”¨ç±»å‹ç”Ÿæˆç‰¹å®šçš„æç¤ºè¯æ¨¡æ¿
                let specialInstructions = '';
                if (appType.includes('ç¥ç»å¤–ç§‘') || appType.includes('æ‰‹æœ¯') || appType.includes('åŒ»ç–—')) {
                    specialInstructions = `
ç‰¹åˆ«æ³¨æ„ï¼šè¿™æ˜¯åŒ»ç–—ç›¸å…³åº”ç”¨ï¼Œè¯·ç¡®ä¿ï¼š
- éµå¾ªåŒ»ç–—è¡Œä¸šçš„ä¸¥æ ¼æ ‡å‡†å’Œè§„èŒƒ
- è€ƒè™‘æ‚£è€…å®‰å…¨å’ŒåŒ»ç–—ä¼¦ç†
- åŒ…å«å¿…è¦çš„å…è´£å£°æ˜å’Œä¸“ä¸šå»ºè®®
- ä½¿ç”¨å‡†ç¡®çš„åŒ»å­¦æœ¯è¯­å’Œä¸“ä¸šè¡¨è¾¾
- å¼ºè°ƒéœ€è¦ä¸“ä¸šåŒ»ç–—äººå‘˜çš„éªŒè¯å’Œç›‘ç£`;
                }

                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæç¤ºè¯å·¥ç¨‹å¸ˆï¼Œç‰¹åˆ«æ“…é•¿åŒ»ç–—å’ŒæŠ€æœ¯é¢†åŸŸçš„æç¤ºè¯è®¾è®¡ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªé«˜è´¨é‡çš„AIæç¤ºè¯ï¼š

ä¸»é¢˜ï¼š${topic}
åº”ç”¨ç±»å‹ï¼š${appType || 'é€šç”¨'}
è¯¦ç»†ç¨‹åº¦ï¼š${detailLevel}
${specialInstructions}

è¯·ç”Ÿæˆä¸€ä¸ªç»“æ„æ¸…æ™°ã€æè¿°å‡†ç¡®ã€æ•ˆæœå¯¼å‘çš„æç¤ºè¯ã€‚æç¤ºè¯åº”è¯¥åŒ…å«ï¼š
1. æ˜ç¡®çš„è§’è‰²å®šä¹‰ï¼ˆå¦‚æœæ˜¯åŒ»ç–—ç›¸å…³ï¼Œéœ€è¦æŒ‡å®šä¸“ä¸šé¢†åŸŸï¼‰
2. å…·ä½“çš„ä»»åŠ¡æè¿°å’ŒæœŸæœ›ç›®æ ‡
3. æ¸…æ™°çš„è¾“å‡ºæ ¼å¼å’Œç»“æ„è¦æ±‚
4. ç›¸å…³çš„çº¦æŸæ¡ä»¶å’Œæ³¨æ„äº‹é¡¹
5. è´¨é‡æ ‡å‡†å’ŒéªŒè¯è¦æ±‚

è¯·ç›´æ¥è¾“å‡ºæç¤ºè¯å†…å®¹ï¼Œä¸éœ€è¦é¢å¤–è§£é‡Šã€‚`;

                const result = await callAPI(prompt);
                showResult(result);
                saveToHistory('ä¸»é¢˜ç”Ÿæˆ', topic, result);
                
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                showAPIStatus('error', `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`);
            } finally {
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>ç”Ÿæˆæç¤ºè¯';
                btn.disabled = false;
            }
        }

        // ä»å›¾ç‰‡ç”Ÿæˆæç¤ºè¯
        async function generateFromImage() {
            if (!currentImage) {
                showAPIStatus('error', 'âŒ è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            
            // æ›´æ–°é…ç½®åˆ°å†…å­˜
            config.apiType = document.getElementById('apiType').value;
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.model = getActualModel();
            
            if (!config.apiKey) {
                showAPIStatus('error', 'âŒ è¯·å…ˆé…ç½®API Key');
                return;
            }

            const analysisType = document.getElementById('analysisType').value;
            const btn = document.getElementById('generateImageBtn');
            btn.innerHTML = '<div class="loading inline-block mr-2"></div>åˆ†æä¸­...';
            btn.disabled = true;

            try {
                // æ ¹æ®åˆ†æç±»å‹è°ƒæ•´æç¤ºè¯
                let analysisPrompt = '';
                if (analysisType.includes('åŒ»å­¦') || analysisType.includes('æ‰‹æœ¯') || analysisType.includes('åŒ»ç–—') || analysisType.includes('è§£å‰–') || analysisType.includes('ä¸´åºŠ')) {
                    analysisPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»å­¦å½±åƒåˆ†æå’ŒAIæç¤ºè¯ç”Ÿæˆä¸“å®¶ï¼Œå…·æœ‰ä¸°å¯Œçš„ç¥ç»å¤–ç§‘å’Œæ‰‹æœ¯æœºå™¨äººç»éªŒã€‚è¯·ä»”ç»†åˆ†æè¿™å¼ åŒ»ç–—ç›¸å…³å›¾ç‰‡ã€‚

åˆ†æé‡ç‚¹ï¼š${analysisType}

è¯·ä»åŒ»ç–—ä¸“ä¸šè§’åº¦è¿›è¡Œåˆ†æï¼š
1. åŒ»ç–—åœºæ™¯è¯†åˆ«ï¼ˆæ‰‹æœ¯å®¤ã€æ£€æŸ¥å®¤ã€è®¾å¤‡ç­‰ï¼‰
2. åŒ»ç–—è®¾å¤‡å’Œå™¨æ¢°è¯†åˆ«
3. è§£å‰–ç»“æ„æˆ–ç—…ç†ç‰¹å¾ï¼ˆå¦‚é€‚ç”¨ï¼‰
4. åŒ»ç–—ç¯å¢ƒçš„æ ‡å‡†åŒ–è¦æ±‚
5. ä¸“ä¸šæœ¯è¯­å’ŒæŠ€æœ¯è§„èŒƒ
6. å›¾åƒè´¨é‡å’Œè¯Šæ–­ä»·å€¼

ç”Ÿæˆçš„æç¤ºè¯åº”è¯¥ï¼š
- ä½¿ç”¨å‡†ç¡®çš„åŒ»å­¦æœ¯è¯­
- ç¬¦åˆåŒ»ç–—è¡Œä¸šæ ‡å‡†
- é€‚ç”¨äºåŒ»ç–—åŸ¹è®­æˆ–æ–‡æ¡£ç”Ÿæˆ
- åŒ…å«å¿…è¦çš„ä¸“ä¸šå…è´£å£°æ˜

è¯·ç›´æ¥è¾“å‡ºåŒ»ç–—çº§åˆ«çš„ä¸“ä¸šæç¤ºè¯ã€‚`;
                } else {
                    analysisPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒåˆ†æå’Œæç¤ºè¯ç”Ÿæˆä¸“å®¶ã€‚è¯·ä»”ç»†åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„AIå›¾åƒç”Ÿæˆæç¤ºè¯ã€‚

åˆ†æé‡ç‚¹ï¼š${analysisType}

è¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œåˆ†æå¹¶ç”Ÿæˆæç¤ºè¯ï¼š
1. ä¸»è¦å†…å®¹å’Œä¸»é¢˜
2. è‰ºæœ¯é£æ ¼å’ŒæŠ€æ³•
3. è‰²å½©æ­é…å’Œå…‰å½±æ•ˆæœ
4. æ„å›¾å’Œå¸ƒå±€
5. ç»†èŠ‚æè¿°å’Œè´¨æ„Ÿ
6. æŠ€æœ¯å‚æ•°å’Œè®¾å¤‡ä¿¡æ¯

ç”Ÿæˆçš„æç¤ºè¯åº”è¯¥èƒ½å¤Ÿè®©AIé‡æ–°åˆ›é€ å‡ºç±»ä¼¼é£æ ¼å’Œè´¨é‡çš„å›¾åƒã€‚è¯·ä½¿ç”¨è‹±æ–‡å…³é”®è¯ï¼Œå¹¶æŒ‰ç…§é‡è¦æ€§æ’åºã€‚

è¯·ç›´æ¥è¾“å‡ºæç¤ºè¯ï¼Œæ ¼å¼ä¸ºï¼šä¸»è¦æè¿°, é£æ ¼æè¿°, æŠ€æœ¯å‚æ•°`;
                }

                const result = await callAPIWithImage(analysisPrompt, currentImage);
                showResult(result);
                saveToHistory('å›¾ç‰‡åæ¨', 'å›¾ç‰‡åˆ†æ', result);
                
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                showAPIStatus('error', `âŒ å›¾ç‰‡åˆ†æå¤±è´¥: ${error.message}`);
            } finally {
                btn.innerHTML = '<i class="fas fa-search mr-2"></i>åˆ†æå›¾ç‰‡ç”Ÿæˆæç¤ºè¯';
                btn.disabled = false;
            }
        }

        // è°ƒç”¨API
        async function callAPI(prompt) {
            const apiType = config.apiType;
            
            switch(apiType) {
                case 'gemini':
                    return await callGeminiAPI(prompt);
                case 'deepseek':
                case 'moonshot':
                case 'custom':
                    return await callOpenAIAPI(prompt);
                case 'anthropic':
                    return await callAnthropicAPI(prompt);
                case 'qwen':
                    return await callQwenAPI(prompt);
                case 'baidu':
                    return await callBaiduAPI(prompt);
                case 'zhipu':
                    return await callZhipuAPI(prompt);
                default:
                    return await callOpenAIAPI(prompt);
            }
        }

        // è°ƒç”¨å¸¦å›¾ç‰‡çš„API
        async function callAPIWithImage(prompt, image) {
            const apiType = config.apiType;
            
            switch(apiType) {
                case 'gemini':
                    return await callGeminiAPIWithImage(prompt, image);
                case 'deepseek':
                case 'moonshot':
                case 'custom':
                    return await callOpenAIAPIWithImage(prompt, image);
                case 'anthropic':
                    return await callAnthropicAPIWithImage(prompt, image);
                case 'qwen':
                    return await callQwenAPIWithImage(prompt, image);
                case 'baidu':
                    return await callBaiduAPIWithImage(prompt, image);
                case 'zhipu':
                    return await callZhipuAPIWithImage(prompt, image);
                default:
                    return await callOpenAIAPIWithImage(prompt, image);
            }
        }

        // OpenAI APIè°ƒç”¨
        async function callOpenAIAPI(prompt) {
            try {
                const response = await fetch(`${config.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('OpenAI APIè¿”å›æ ¼å¼å¼‚å¸¸');
                }
                
                return data.choices[0].message.content;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåœ°å€');
                }
                throw error;
            }
        }

        // OpenAI APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callOpenAIAPIWithImage(prompt, image) {
            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Gemini APIè°ƒç”¨
        async function callGeminiAPI(prompt) {
            const response = await fetch(`${config.apiUrl}/v1/models/${config.model}:generateContent?key=${config.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Anthropic Claude APIè°ƒç”¨
        async function callAnthropicAPI(prompt) {
            const response = await fetch(`${config.apiUrl}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': config.apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: config.model,
                    max_tokens: 2000,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // Anthropic Claude APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callAnthropicAPIWithImage(prompt, image) {
            const base64Data = image.split(',')[1];
            const mimeType = image.split(',')[0].split(':')[1].split(';')[0];

            const response = await fetch(`${config.apiUrl}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': config.apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: config.model,
                    max_tokens: 2000,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // é€šä¹‰åƒé—®APIè°ƒç”¨
        async function callQwenAPI(prompt) {
            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // é€šä¹‰åƒé—®APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callQwenAPIWithImage(prompt, image) {
            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // ç™¾åº¦æ–‡å¿ƒä¸€è¨€APIè°ƒç”¨
        async function callBaiduAPI(prompt) {
            // æ–‡å¿ƒä¸€è¨€éœ€è¦å…ˆè·å–access_tokenï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
            const response = await fetch(`${config.apiUrl}/wenxinworkshop/chat/${config.model}?access_token=${config.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_output_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.result;
        }

        // ç™¾åº¦æ–‡å¿ƒä¸€è¨€APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callBaiduAPIWithImage(prompt, image) {
            const base64Data = image.split(',')[1];
            
            const response = await fetch(`${config.apiUrl}/wenxinworkshop/chat/${config.model}?access_token=${config.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image',
                                    image: base64Data
                                }
                            ]
                        }
                    ],
                    temperature: 0.7,
                    max_output_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.result;
        }

        // æ™ºè°±ChatGLM APIè°ƒç”¨
        async function callZhipuAPI(prompt) {
            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // æ™ºè°±ChatGLM APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callZhipuAPIWithImage(prompt, image) {
            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Gemini APIå¸¦å›¾ç‰‡è°ƒç”¨
        async function callGeminiAPIWithImage(prompt, image) {
            // æå–base64æ•°æ®
            const base64Data = image.split(',')[1];
            const mimeType = image.split(',')[0].split(':')[1].split(';')[0];

            const response = await fetch(`${config.apiUrl}/v1/models/${config.model}:generateContent?key=${config.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                },
                                {
                                    inline_data: {
                                        mime_type: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(result) {
            document.getElementById('resultText').textContent = result;
            document.getElementById('resultArea').classList.remove('hidden');
        }

        // å¤åˆ¶ç»“æœ
        function copyResult() {
            const resultText = document.getElementById('resultText').textContent;
            navigator.clipboard.writeText(resultText).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(type, input, output) {
            const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            history.unshift({
                type,
                input,
                output,
                timestamp: new Date().toLocaleString()
            });
            
            // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
            if (history.length > 20) {
                history.splice(20);
            }
            
            localStorage.setItem('promptHistory', JSON.stringify(history));
            loadHistory();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-white/50 text-sm">æš‚æ— å†å²è®°å½•</p>';
                return;
            }
            
            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white/5 rounded p-2 cursor-pointer hover:bg-white/10 transition';
                div.innerHTML = `
                    <div class="text-xs text-blue-300">${item.type}</div>
                    <div class="text-sm truncate">${item.input}</div>
                    <div class="text-xs text-white/50">${item.timestamp}</div>
                `;
                div.onclick = () => showHistoryItem(item);
                historyList.appendChild(div);
            });
        }

        // æ˜¾ç¤ºå†å²è®°å½•é¡¹
        function showHistoryItem(item) {
            showResult(item.output);
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('promptHistory');
                loadHistory();
            }
        }
    </script>
</body>
</html>
